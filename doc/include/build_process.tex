\chapter{Build process}
\label{chap:build_process}

\section{Dependencies}
\label{sec:dependencies}

\subsection{premake}
\label{sec:dependencies_premake}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> required \\
  Version:     \> 5.0.0 (alpha15) \\
  License:     \> BSD \\
  Homepage:    \> \href{https://premake.github.io/}{premake.github.io}
\end{tabbing}

\subsubsection{Installation}

Place the binary somewhere in your \path{PATH}.  Depending on your
platform, you should run \path{premake} using the scripts
\path{Builds/render_templates.sh} or
\path{Builds/render_templates.bat}.

To change the premake file using Jinja templates, you'll also have to
install the necessary dependencies.

\subsection{Compilers}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> required \\
  Linux:       \> Clang 6.0 (or gcc 7.5.0) \\
  Windows:     \> Visual Studio 2017 (and above) \\
  License:     \> proprietary (Visual Studio) / Open Source \\
\end{tabbing}

Use premake (\ref{sec:dependencies_premake}) to generate the Make
files (or project) files needed by different compilers.

\emph{Different compiler versions may work, and premake supports other
  compiler tool sets as well.  But in this case, you're on your own!}

\subsection{JUCE library}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> required \\
  Version:     \> 5.4.7 \\
  License:     \> ISC and GPL v3 (among others) \\
  Homepage:    \> \href{http://www.juce.com/}{www.juce.com}
\end{tabbing}

\subsubsection{Installation}

Extract the archive into the directory \path{libraries/juce}.

\subsection{Virtual Studio Technology SDK}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 2.4 / 3.6.14 \\
  License:     \> proprietary / GPL v3 \\
  Homepage:    \> \href{http://www.steinberg.net/en/company/developer.html}{www.steinberg.net}
\end{tabbing}

\subsubsection{Installation}

Extract the archives into the directories \path{libraries/vst2} and
\path{libraries/vst3}.  The proprietary VST2 SDK is not available
anymore.  \textbf{You may only distribute VST2 plug-ins if you have
  signed the old license agreement!}

\subsection{Python}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 3.6 (or higher) \\
  License:     \> Python Software Foundation License \\
  Homepage:    \> \href{http://www.python.org/}{www.python.org}
\end{tabbing}

You'll only need Python if you want to auto-generate files from Jinja
templates.

\subsubsection{Installation (Windows)}

You can download an installer from the website.

\subsection{Jinja}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 2.10 (or higher) \\
  License:     \> BSD \\
  Homepage:    \> \href{http://jinja.pocoo.org/}{jinja.pocoo.org}
\end{tabbing}

You'll only need Jinja if you want to auto-generate files such as the
premake file from templates (see \ref{sec:dependencies_premake}).

\subsection{Artistic Style}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 3.1 \\
  License:     \> LGPL v3 \\
  Homepage:    \> \href{http://astyle.sourceforge.net/}{astyle.sourceforge.net}
\end{tabbing}

This application formats the code so it looks more beautiful and
consistent.  Thus, you only have to install it if you plan to help me
with coding.

\subsubsection{Installation}

Place the binary somewhere in your \path{PATH}.  Depending on your
platform, you should run \path{astyle} using the scripts
\path{Source/format_code.sh} or \path{Source/format_code.bat}.

\subsection{googletest}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 1.10.0 \\
  License:     \> BSD 3-clauses \\
  Homepage:    \> \href{https://github.com/google/googletest}{github.com/google/googletest}
\end{tabbing}

This is a framework for testing and mocking.  You only need to install
it if you plan to help me with coding.

\subsubsection{Installation on GNU/Linux}

Extract the archive into the directory \path{libraries/googletest},
change into this directory and run:

\begin{VerbatimBoth}
  mkdir googletest/build
  cd googletest/build
\end{VerbatimBoth}

\begin{Verbatim32}
  rm -f ./CMakeCache.txt
  cmake ..
  make
  mkdir -p lib/linux/i386/
  mv lib/*.a lib/linux/i386/
  make clean
\end{Verbatim32}

\begin{Verbatim64}
  rm -f ./CMakeCache.txt
  cmake ..
  make
  mkdir -p lib/linux/amd64/
  mv lib/*.a lib/linux/amd64/
  make clean
\end{Verbatim64}

\newpage %% layout

\section{GNU/Linux}

\subsection{Environment}

To build this application yourself, I recommend setting up a
\texttt{chroot} environment.  This is fast and easy to do on
Debian-based systems and might save you a \textbf{lot} of trouble.  At
the time of writing, I'm using Linux Mint 19, but the procedure should
be similar on your distribution of choice.

Start by installing the necessary packages:

\begin{VerbatimBoth}
  sudo apt install debootstrap schroot
\end{VerbatimBoth}

Then install the \texttt{chroot} base system by executing the
following statements:

\begin{Verbatim32}
  sudo debootstrap --variant=buildd \
    --arch i386 bionic \
    /srv/chroot/bionic_i386 \
    http://archive.ubuntu.com/ubuntu
\end{Verbatim32}

\begin{Verbatim64}
  sudo debootstrap --variant=buildd \
    --arch amd64 bionic \
    /srv/chroot/bionic_amd64 \
    http://archive.ubuntu.com/ubuntu
\end{Verbatim64}

Running \path{debootstrap} will take some time.  Meanwhile, add the
following lines to \path{/etc/schroot/schroot.conf} (make sure you
remove all preceding white space so that each line begins in the first
column):

\begin{VerbatimBoth}
  [bionic-i386]
  description=Ubuntu bionic (i386)
  directory=/srv/chroot/bionic_i386
  profile=default
  personality=linux32
  type=directory
  users=username

  [bionic-amd64]
  description=Ubuntu bionic (amd64)
  directory=/srv/chroot/bionic_amd64
  profile=default
  personality=linux
  type=directory
  users=username
\end{VerbatimBoth}

Please make the necessary changes to \texttt{username}.  If you
experience problems, you can try to change \texttt{bionic} to a
release name such as \texttt{wheezy}.

When \path{debootstrap} is done, log in as superuser:

\begin{Verbatim32}
  sudo schroot -c bionic-i386
\end{Verbatim32}

\begin{Verbatim64}
  sudo schroot -c bionic-amd64
\end{Verbatim64}

You'll have to change the file \path{/etc/apt/sources.list} first
(ignore the line break, it should be a single line):

\begin{VerbatimBoth}
  deb http://archive.ubuntu.com/ubuntu bionic
  main restricted universe
\end{VerbatimBoth}

Now install a few packages -- \path{less} and \path{vim} are optional,
but might come in handy:

\begin{VerbatimBoth}
  apt update
  apt -y install bash-completion clang \
    cmake libasound2-dev libjack-jackd2-dev \
    libpthread-workqueue-dev mesa-common-dev \
    xorg-dev less vim
  apt clean
\end{VerbatimBoth}

If you like \path{bash} completion, you might also want to open the
file \path{/etc/bash.bashrc} and unquote these lines:

\begin{VerbatimBoth}
  # enable bash completion in interactive shells
  if [...]
    [a couple of lines...]
  fi
\end{VerbatimBoth}

Finally, log out and log in as normal user:

\begin{Verbatim32}
  schroot -c bionic-i386
\end{Verbatim32}

\begin{Verbatim64}
  schroot -c bionic-amd64
\end{Verbatim64}

In this \path{chroot} shell, install the dependencies
(\ref{sec:dependencies}).  Congratulations -- you are now ready to
build!

\subsection{Build}

After preparing the dependencies, start your \texttt{chroot}
environment

\begin{Verbatim32}
  schroot -c bionic-i386
\end{Verbatim32}

\begin{Verbatim64}
  schroot -c bionic-amd64
\end{Verbatim64}

change into the directory \path{Builds} and execute

\begin{VerbatimBoth}
  ./render_templates.sh
  make config=CFG TARGET
\end{VerbatimBoth}

where \application{CFG} is one of \application{debug\_x32},
\application{debug\_x64}, \application{release\_x32} and
\application{release\_x64}, and \application{TARGET} is the version
you want to compile, such as \application{linux\_standalone\_stereo}.

In case you run into problems, you can try to switch compilers by
opening the file \texttt{run\_premake.sh} and using the premake
options \texttt{--cc=clang} or \texttt{--cc=gcc}.

The compiled binaries will end up in the directory \path{bin}.

\section{Microsoft Windows}

\subsection{Build}

After setting up the dependencies, open the directory \path{Builds}
and execute

\begin{VerbatimBoth}
  ./render_templates.bat
\end{VerbatimBoth}

Then change into the directory \path{Builds/windows/vs20xx}, open the
project file with the corresponding version of Visual Studio and build
the project.

The compiled binaries will end up in the directory \path{bin}.

%%% Local Variables:
%%% mode: latex
%%% mode: outline-minor
%%% TeX-command-default: "Rubber"
%%% TeX-master: "../trakmeter"
%%% TeX-PDF-mode: t
%%% ispell-local-dictionary: "british"
%%% End:
